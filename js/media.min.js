var kazi_media_fieldformname="";var kazi_media_fieldname="";var kazi_media_appname="";var kazi_media_comname="";var kazi_media_subsetname="";var kazi_media_saving_type="";var kazi_media_for_comment="";jQuery(document).ready(function(){jQuery(".delete_media").click(function(a){media_manager.deleteTrHtml(jQuery(this))});jQuery(".kazi-medias-server-link").click(function(a){media_manager.getMediaList()});jQuery("#mediaModal").on("hide.bs.modal",function(a){jQuery(".kazi-medias-progress").html("")});jQuery(".kazi_media_upload").click(function(){var a=jQuery(this);jQuery("#mediaModal .kazicode_media_source").val("media");media_manager.prepareDefaults(a)});jQuery("#kazicode_media_search_keyword").blur(function(){media_manager.getMediaList()});jQuery("#kazicode_media_search_type").change(function(){media_manager.getMediaList()});jQuery("#kazicode_media_search_error").change(function(){media_manager.getMediaList()});jQuery("#kazicode_media").change(function(){this_element=jQuery(this);jQuery.each(this.files,function(b,a){media_manager.sendFile(this_element,b,a,kazi_media_fieldname,kazi_media_fieldformname)})});jQuery("#dropzone").on("dragover",function(a){a.preventDefault();a.stopPropagation()});jQuery("#dropzone").on("dragenter",function(a){a.preventDefault();a.stopPropagation()});jQuery("#dropzone").on("drop",function(a){if(a.originalEvent.dataTransfer){if(a.originalEvent.dataTransfer.files.length){this_element=jQuery(this);a.preventDefault();a.stopPropagation();file_list=a.originalEvent.dataTransfer.files;jQuery.each(file_list,function(c,b){media_manager.sendFile(this_element,c,b,kazi_media_fieldname,kazi_media_fieldformname)})}}})});media_manager=function(){return{prepareDefaults:function(a){kazi_media_fieldformname=a.attr("field_form_name");kazi_media_fieldname=a.attr("field_name");kazi_media_appname=a.attr("application_name");kazi_media_comname=a.attr("component_name");kazi_media_subsetname=a.attr("subset_name");kazi_media_saving_type=a.attr("saving_type");kazi_media_for_comment=a.attr("for_comment")},sendFile:function(e,d,c,b,g){html=jQuery(".kazi-media-progress-default").html();html='<div class="kazi-media-progress_'+d+'">'+html+"</div>";jQuery(".kazi-medias-progress").append(html);jQuery(".kazi-media-progress_"+d+" .kazi-media-name").html(c.name);var f=new FormData();f.append("media",c);var h=e.closest(".modal-body").find("#kazicode_media_title").val();var a=kazist_document.document.root_route;console.log(kazist_document.document.root_route);f.append("_token",jQuery("#_token").val());jQuery.ajax({type:"POST",url:kazist_document.document.web_base+"/media/media/upload?name="+c.name+"&title="+h+"&root_route="+a,data:f,mimeType:"multipart/form-data",cache:false,processData:false,dataType:"json",contentType:false,success:function(){},xhrFields:{onprogress:function(j){var i=Math.floor((j.total/j.totalSize)*100);jQuery(".kazi-media-progress_"+d+" .kazi-media-size").html(j.total+"KB");jQuery(".kazi-media-progress_"+d+" .progress-bar").width(i+"%");if(i===100){jQuery(".kazi-media-progress_"+d+" .progress-bar").width("100%").removeClass("progress-bar-red").addClass("progress-bar-green")}}}}).done(function(i){console.log(i);jQuery(".kazi-media-progress_"+d+" .progress-bar").width("100%").removeClass("progress-bar-red").addClass("progress-bar-green");jQuery.each(i.records,function(j,k){if(kazi_media_saving_type=="json"||kazi_media_saving_type=="multiple"){media_manager.getTrHtml(k,b)}else{media_manager.getImageHtml(k,b)}})})},getMediaList:function(f){var a=new Array;var d=new FormData();var c=jQuery("#kazicode_media_search_keyword").val();var e=jQuery("#kazicode_media_search_type").val();var g=jQuery("#kazicode_media_search_error").val();var b=jQuery("#kazicode_media_source").val();d.append("keyword",c);d.append("type",e);d.append("error",g);d.append("source",b);jQuery("."+kazi_media_fieldname+"_medias_list #"+kazi_media_fieldname+"_medias_value").each(function(){d.append("ids[]",jQuery(this).val())});jQuery(".kazi-medias-server").html("");jQuery(".kazi-medialist-progress .progress-bar").width("20%");jQuery(".kazi-medialist-progress").show();if(f){d.append("offset",f)}d.append("_token",jQuery("#_token").val());jQuery.ajax({type:"POST",url:kazist_document.document.web_base+"/media/media/listing",data:d,cache:false,processData:false,contentType:false,success:function(){}}).done(function(h){jQuery(".kazi-medialist-progress").show();jQuery(".kazi-medialist-progress .progress-bar").width("60%");h=jQuery.parseJSON(h);var i="<ul>";jQuery.each(h.records,function(j,k){i+=media_manager.getServerLiHtml(k)});i+="</ul>";i+='<div class="clr"></div>';i=jQuery(i);i.find(".inset_media_record").on("click",function(){var j=jQuery(this);media_manager.prepareDocument4Insert(j)});media_manager.setPaginationParams(h);jQuery(".kazi-medias-server").html(i);jQuery(".kazi-medialist-progress .progress-bar").width("100%");jQuery(".kazi-medialist-progress").hide()})},setPaginationParams:function(a){var b=1;jQuery("#kazi-medias-server-wrapper .previous").removeClass("disabled");jQuery("#kazi-medias-server-wrapper .next").removeClass("disabled");if(a.offset===0){jQuery("#kazi-medias-server-wrapper .previous").addClass("disabled").off()}else{jQuery("#kazi-medias-server-wrapper .previous").off().on("click",function(c){c.stopPropagation();offset=a.offset-a.limit;media_manager.getMediaList(offset)})}if((a.total-a.offset)<a.limit){jQuery("#kazi-medias-server-wrapper .next").addClass("disabled").off()}else{jQuery("#kazi-medias-server-wrapper .next").off().on("click",function(c){c.stopPropagation();offset=+a.offset+ +a.limit;media_manager.getMediaList(offset)})}page_count=Math.ceil(a.total/a.limit);if(a.offset>0){b=Math.ceil(a.offset/a.limit)+1}if(page_count>1){jQuery("#kazi-medias-server-wrapper .page_count").html("Page "+b+" of "+page_count)}},prepareDocument4Insert:function(e){var c=new Object();var b=jQuery("#mediaModal .kazicode_media_source").val();var d=jQuery("#mediaModal .kazicode_media_input_id").val();c.id=e.closest("li").find(".media_id").val();c.title=e.closest("li").find(".media_title").val();c.image=e.closest("li").find(".media_image").val();e.closest("li").hide("slow",function(){jQuery(this).remove()});if(b=="media"){if(parseInt(kazi_media_for_comment)){media_manager.getCommentImageHtml(c,kazi_media_fieldname)}else{if(kazi_media_saving_type=="json"||kazi_media_saving_type=="multiple"){media_manager.getTrHtml(c,kazi_media_fieldname)}else{media_manager.getImageHtml(c,kazi_media_fieldname)}}}else{var f=c.image;var a=f.replace("../","");jQuery("#"+d).val(a);jQuery("#mediaModal").modal("hide")}},getCommentImageHtml:function(a,c){var b="";b+='<li style="margin-top:10px;">';b+='<a class="label label-danger delete_media"><span class="glyphicon glyphicon-trash"></span></a>';b+='&nbsp; <img width="32px" src="'+kazist_document.document.web_root+"/"+a.image+'"/>';b+="&nbsp; "+a.title;b+='<input class="comment_attachment_ids"  type="hidden" value="'+a.id+'"/>';b+="</li>";b=jQuery(b);b.find(".delete_media").click(function(){media_manager.deleteLiHtml(jQuery(this))});jQuery(".comment_attachment_"+c+" ul").append(b)},getImageHtml:function(a,c){var b="";b+='<img src="'+kazist_document.document.web_root+"/"+a.image+'"/> ';b+='<input id="'+c+'_medias_value" name="form['+c+']" type="hidden" value="'+a.id+'"/>';jQuery("."+c+"_medias_single").html(b)},getTrHtml:function(a,c){var b="";b+="<tr>";b+="<td>";b+='<img width="32px" src="'+kazist_document.document.web_root+"/"+a.image+'" class="tooltip_element" data-placement="bottom" data-toggle="tooltip" title="'+a.title+'"/>';b+="</td>";b+="<td>";b+=a.title;b+='<input id="'+c+'_medias_value" name="form['+c+'][]" type="hidden" value="'+a.id+'"/>';b+="</td>";b+="<td>";b+='<a class="label label-danger delete_media"><span class="glyphicon glyphicon-trash"></span></a>';b+="</td>";b+="</tr>";b=jQuery(b);b.find(".delete_media").click(function(){media_manager.deleteTrHtml(jQuery(this))});jQuery("."+c+"_medias_list").append(b)},deleteTrHtml:function(a){var b=confirm("Are you sure you want to delete?");if(b){a.closest("tr").remove()}},deleteLiHtml:function(a){var b=confirm("Are you sure you want to delete?");if(b){a.closest("li").remove()}},getServerLiHtml:function(a){var b="";b+="<li>";b+='<img width="64px" height="64px" src="'+kazist_document.document.web_root+"/"+a.image+'" class="tooltip_element" data-placement="bottom" data-toggle="tooltip" title="'+a.title+'"/>';b+="<br>";b+=a.title;b+='<input class="media_id" type="hidden" name="" value="'+a.id+'">';b+='<input class="media_title" type="hidden" name="" value="'+a.title+'">';b+='<input class="media_image" type="hidden" name="" value="'+a.image+'">';b+="<br>";b+="<br>";b+='<a href="#" class="inset_media_record"><span class="label label-info"><span class="glyphicon glyphicon-pencil"> Insert</span></span></a>';b+="</li>";return b}}}();